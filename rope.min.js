var Candy=Candy||{NUM_OF_LEVELS_TO_LOAD:3,enumify:function(){"use strict";var a,b=Array.prototype.slice.call(arguments),c={keys:b};for(a=0;a<arguments.length;a+=1)c[b[a]]=a;return Object.freeze(c)},SAVE_KEY:"saveKey",SAVE_VERSION:1,levelData:{levels:[]}};Candy.Boot=function(){"use strict"},Candy.Boot.prototype={preload:function(){"use strict";this.load.image("preloaderBar","assets/loading-bar.png"),this.load.json("constantsConfig","config/CONSTANTS.json")},create:function(){"use strict";this.scale.scaleMode=Phaser.ScaleManager.SHOW_ALL,this.scale.pageAlignHorizontally=!0,this.scale.pageAlignVertically=!0,this.scale.setScreenSize(!0),Candy.CONSTANTS=this.cache.getJSON("constantsConfig"),this.state.start("Preloader")}},Candy.LabelButton=function(a,b,c,d,e,f,g,h,i,j,k){"use strict";Phaser.Button.call(this,a,b,c,d,f,g,h,i,j,k),this.style={font:"10px Arial",fill:"black"},this.anchor.setTo(.5,.5),this.label=new Phaser.Text(a,0,0,e,this.style),this.label.anchor.setTo(.5,.5),this.addChild(this.label),this.setLabel(e),a.add.existing(this)},Candy.LabelButton.prototype=Object.create(Phaser.Button.prototype),Candy.LabelButton.prototype.constructor=Candy.LabelButton,Candy.LabelButton.prototype.setLabel=function(a){"use strict";this.label.setText(a)},Candy.Game=function(a){"use strict";function b(){if(l.cursors.down.isDown)return!1;var a,b,c,d=l.layerSolid,e=(j.getLayerIndex("layer1"),d.getTileX(l.player.body.x)),f=d.getTileX(l.player.body.right),g=d.getTileY(l.player.body.y-(Candy.CONSTANTS.DEFAULT_PLAYER_HEIGHT-Candy.CONSTANTS.DUCKING_PLAYER_HEIGHT));return b=j.getTile(e,g,d,!0),c=j.getTile(f,g,d,!0),a=b&&b.collideDown||c&&c.collideDown,!a}function c(){var a,b=l.layerbackground.getTiles(l.player.x,l.player.y-1,l.player.width,l.player.height/2);for(b.sort(function(a,b){return a.worldY>b.worldY?1:a.worldY<b.worldY?-1:0}),a=0;a<b.length;a+=1)if(b[a].index===Candy.CONSTANTS.ROPE_INDEX)return k=b[a],!0;return!1}function d(){l.player.body.setSize(Candy.CONSTANTS.DEFAULT_PLAYER_WIDTH,Candy.CONSTANTS.DEFAULT_PLAYER_HEIGHT,Candy.CONSTANTS.DEFAULT_PLAYER_OFFSET_X,Candy.CONSTANTS.DEFAULT_PLAYER_OFFSET_Y)}this.playerStates=Candy.enumify("STANDING","DUCKING","CLIMBING"),this.player=null,this.platforms=null,this.cursors=null,this.stars=null,this.cursors=null,this.layerSolid=null,this.layerSolidTop=null,this.layerforeground=null,this.layerbackground=null,this.collidingLayers=null,this.jump=null,this.pickup=null;var e=150,f=100,g=5,h={},i={},j=null,k=null,l=this;h[this.playerStates.CLIMBING]=function(){l.player.body.moves=!0},i[this.playerStates.STANDING]=function(){d()},i[this.playerStates.DUCKING]=function(){l.player.body.setSize(Candy.CONSTANTS.DUCKING_PLAYER_WIDTH,Candy.CONSTANTS.DUCKING_PLAYER_HEIGHT)},i[this.playerStates.CLIMBING]=function(){d(),l.player.animations.play("climb"),l.player.body.moves=!1,l.player.x=k.worldX+k.width/2},this.updatePlayerState=function(){var a=this.player.currentState;switch(this.player.currentState){case this.playerStates.STANDING:this.cursors.down.isDown?this.player.currentState=this.playerStates.DUCKING:this.cursors.up.isDown&&c()&&(this.player.currentState=this.playerStates.CLIMBING);break;case this.playerStates.DUCKING:b()?this.player.currentState=this.playerStates.STANDING:this.cursors.up.isDown&&c()&&(this.player.currentState=this.playerStates.CLIMBING);break;case this.playerStates.CLIMBING:this.player.body.blocked.down?this.player.currentState=this.playerStates.STANDING:this.input.keyboard.isDown(Phaser.Keyboard.SPACEBAR)&&!this.cursors.up.isDown&&(this.jump.play(),this.player.body.velocity.y=-150,this.player.currentState=this.playerStates.STANDING);break;default:throw"No way to leave this state"}this.player.currentState!==a&&(h[a]&&h[a](),i[this.player.currentState]&&i[this.player.currentState]())},this.actOnPlayerState=function(){switch(this.player.currentState){case this.playerStates.STANDING:this.cursors.left.isDown?(this.player.body.velocity.x=-e,this.player.animations.play("left")):this.cursors.right.isDown?(this.player.body.velocity.x=e,this.player.animations.play("right")):(this.player.animations.stop(),this.player.frame=4);break;case this.playerStates.DUCKING:this.player.body.facing===Phaser.LEFT?this.player.frame=10:this.player.body.facing===Phaser.RIGHT&&(this.player.frame=9),this.cursors.left.isDown?this.player.body.velocity.x=-f:this.cursors.right.isDown?this.player.body.velocity.x=f:this.player.animations.stop();break;case this.playerStates.CLIMBING:this.cursors.up.isDown?(c()&&!l.player.body.blocked.up&&(this.player.y-=g,c()||(this.player.y+=g)),l.player.animations.play("climb")):this.cursors.down.isDown?(c()&&!l.player.body.blocked.down&&(this.player.y+=g,c()||(this.player.y-=g)),l.player.animations.play("climb")):this.player.animations.stop();break;default:throw"Invalid player state"}this.input.keyboard.isDown(Phaser.Keyboard.SPACEBAR)&&(this.player.body.touching.down||this.player.body.onFloor())&&(this.jump.play(),this.player.body.velocity.y=-350)},this.orderLayers=function(){a.world.bringToTop(this.layerbackground),a.world.bringToTop(this.layerSolid),this.player.bringToTop(),a.world.bringToTop(this.layerSolidTop),a.world.bringToTop(this.layerforeground)},this.tileAtCoordsIsEmpty=function(a,b){return!Candy.saveManager.getCurrentLevelMap().getTileWorldXY(a,b)},this.update=function(){this.physics.arcade.collide(this.player,this.platforms),this.physics.arcade.collide(this.stars,this.platforms),this.physics.arcade.collide(this.player,this.layerSolid),this.physics.arcade.collide(this.player,this.layerSolidTop),this.physics.arcade.overlap(this.player,this.stars,this.collectStar,null,this),this.physics.arcade.collide(this.stars,this.layerSolid),this.physics.arcade.collide(this.stars,this.layerSolidTop),this.player.body.velocity.x=0,this.updatePlayerState(),this.actOnPlayerState()},this.setupTiles=function(){j=Candy.saveManager.getCurrentLevelMap(),this.layerbackground=j.createLayer("layer4"),Candy.Rope.init(a),this.player.bringToTop(),this.layerSolid=j.createLayer("layer1"),this.layerSolidTop=j.createLayer("layer2"),this.layerforeground=j.createLayer("layer3"),this.layerbackground.resizeWorld(),j.setCollisionByExclusion([0],!0,"layer1"),j.setCollisionByExclusion([0],!0,"layer2"),this.layerSolidTop.getTiles(0,0,this.game.width,this.game.height,!0).forEach(function(a){a.setCollision(!1,!1,!0,!1)})},this.create=function(){var a,b;this.jump=this.add.audio("jump"),this.pickup=this.add.audio("pickup"),this.physics.startSystem(Phaser.Physics.ARCADE),this.add.sprite(0,0,"sky"),this.platforms=this.add.group(),this.player=this.add.sprite(32,this.world.height-150,"dude"),this.player.anchor.setTo(.5,1),this.player.currentState=this.playerStates.STANDING,this.physics.arcade.enable(this.player),d(),this.player.body.bounce.y=.2,this.player.body.gravity.y=300,this.player.body.collideWorldBounds=!0,this.player.animations.add("left",[0,1,2,3],10,!0),this.player.animations.add("right",[5,6,7,8],10,!0),this.player.animations.add("climb",[11,12],10,!0),this.camera.follow(this.player,Phaser.Camera.FOLLOW_PLATFORMER),this.levelGenerator=new Candy.LevelGenerator(this),b=this.levelGenerator.generateLevel(j),j=b.currentMap,this.layerSolid=b.layerSolid,this.layerSolidTop=b.layerSolidTop,this.layerforeground=b.layerforeground,this.layerbackground=b.layerbackground,this.collidingLayers=[this.layerSolid,this.layerSolidTop],this.stars=this.add.group(),this.stars.enableBody=!0,a=this.stars.create(280,0,"star"),a.body.gravity.y=300,a.body.bounce.y=.7,this.cursors=this.input.keyboard.createCursorKeys(),this.ropeKey=this.input.keyboard.addKey(Phaser.Keyboard.A),this.ropeKey.onDown.add(function(){var a=(this.player.y,this.add.sprite(this.player.x,this.player.y-Candy.CONSTANTS.TILE_HEIGHT/2,"ropeBall")),b=this.player.y-Candy.CONSTANTS.ROPE_THROW_HEIGHT*Candy.CONSTANTS.TILE_HEIGHT;for(b=b>0?b:0;;){if(!(Candy.spriteDoesNotCollideWithLayers(a,this.collidingLayers)&&a.y>b))return a.y=Math.ceil(a.y/Candy.CONSTANTS.TILE_HEIGHT)*Candy.CONSTANTS.TILE_HEIGHT,this.growRopeFromHereOnThisLayer(a.x,a.y,this.layerbackground,[this.layerSolid,this.layerSolidTop]),void a.kill();a.y-=Candy.CONSTANTS.TILE_HEIGHT/2}},this),this.orderLayers()},this.growRopeFromHereOnThisLayer=function(a,b,c,d){for(var e=c.getTileX(a),f=c.getTileY(b),g=c.getTileY(b)+Candy.CONSTANTS.ROPE_MAX_HEIGHT,h=function(){var a;for(a=0;a<d.length;a+=1)if(j.hasTile(e,f,d[a]))return!1;return!0},i=!1;h()&&g>=f;)j.putTile(i?Candy.CONSTANTS.ROPE_INDEX:Candy.CONSTANTS.ROPE_TOP_INDEX,e,f,c),i=!0,f=Math.min(f+1,j.height)}},Candy.Game.prototype={nextLevel:function(){"use strict";Candy.levelData.currentLevel+=1,this.state.start("Game")},collectStar:function(a,b){"use strict";this.pickup.play(),b.kill(),this.nextLevel()},changeTintMaker:function(a){"use strict";return function(){a.tint=16777215*Math.random()}}},Candy.LevelGenerator=function(a){"use strict";function b(b,h){var i,j,k,l,m,n={},o=h.getTileXY(a.player.x,a.player.y,{}),p={x:o.x,y:o.y},q=4;for(b.setLayer("layer1"),b.putTile(c,o.x,o.y+2,h),i=-2;2>=i;i+=1)for(j=-2;2>=j;j+=1)n[o.x+i+","+(o.y+j)]=!0;for(n[p.x+","+p.y]=!0,m={x:o.x,y:o.y},l=Math.random()>.5;p.y>=q;)(Math.random()<d||p.x<0||p.x>=b.width)&&(p.y-=1,m={x:p.x,y:p.y},n[p.x-1+","+p.y]=!0,n[p.x+","+p.y]=!0,n[p.x+1+","+p.y]=!0),p.x+=l?1:-1,p.x=Math.abs(p.x),n[p.x+","+p.y]=!0,l=Math.random()>.5;for(console.log(n),j=Candy.CONSTANTS.TILES_TALL-1;j>=q;j-=1)if(Math.random()<e){for(i=Candy.CONSTANTS.TILES_WIDE-1;i>=0;i-=1){if(n[i+","+j]){k=0;break}0>=k&&Math.random()<f&&(k=g),k>0&&(b.putTile(c,i,j,h),k-=1)}k=!1}}var c=1,d=.25,e=.2,f=.5,g=7;this.generateLevel=function(c){return c?a.layerbackground=c.create("layer4",Candy.CONSTANTS.TILES_WIDE,Candy.CONSTANTS.TILES_TALL,Candy.CONSTANTS.TILE_WIDTH,Candy.CONSTANTS.TILE_HEIGHT):(c=a.add.tilemap(null,Candy.CONSTANTS.TILE_WIDTH,Candy.CONSTANTS.TILE_HEIGHT,Candy.CONSTANTS.TILES_WIDE,Candy.CONSTANTS.TILES_TALL),a.layerbackground=c.createBlankLayer("layer4",Candy.CONSTANTS.TILES_WIDE,Candy.CONSTANTS.TILES_TALL,Candy.CONSTANTS.TILE_WIDTH,Candy.CONSTANTS.TILE_HEIGHT)),c.addTilesetImage("tileset_16x16"),a.player.bringToTop(),a.layerSolid=c.createBlankLayer("layer1",Candy.CONSTANTS.TILES_WIDE,Candy.CONSTANTS.TILES_TALL,Candy.CONSTANTS.TILE_WIDTH,Candy.CONSTANTS.TILE_HEIGHT),a.layerSolidTop=c.createBlankLayer("layer2",Candy.CONSTANTS.TILES_WIDE,Candy.CONSTANTS.TILES_TALL,Candy.CONSTANTS.TILE_WIDTH,Candy.CONSTANTS.TILE_HEIGHT),a.layerforeground=c.createBlankLayer("layer3",Candy.CONSTANTS.TILES_WIDE,Candy.CONSTANTS.TILES_TALL,Candy.CONSTANTS.TILE_WIDTH,Candy.CONSTANTS.TILE_HEIGHT),a.layerbackground.resizeWorld(),b(c,a.layerSolid,a.layerSolidTop,a.layerbackground,a.layerforeground),c.setCollisionByExclusion([0],!0,"layer1"),c.setCollisionByExclusion([0],!0,"layer2"),a.layerSolidTop.getTiles(0,0,a.width,a.height,!0).forEach(function(a){a.setCollision(!1,!1,!0,!1)}),{currentMap:c,layerSolid:a.layerSolid,layerSolidTop:a.layerSolidTop,layerbackground:a.layerbackground,layerforeground:a.layerforeground}}},Candy.LevelGenerator.prototype={get1dIndexMaker:function(a){"use strict";return function(b,c){return b+c*a}}},Candy.LevelSelect=function(){"use strict"},Candy.LevelSelect.prototype={addLevelMaps:function(){"use strict";var a;for(a=1;a<=Candy.NUM_OF_LEVELS_TO_LOAD;a+=1)Candy.levelData.levels[a]=this.add.tilemap(Candy.saveManager.getLevelNameFromNumber(a)),Candy.levelData.levels[a].addTilesetImage("tileset_16x16")},create:function(){"use strict";var a,b=this.cache.getJSON("levelSelectConfig"),c=b.leftSpacing+b.buttonWidth/2,d=b.topSpacing+b.buttonHeight/2;for(this.add.sprite(0,0,"background"),this.buttonArray=[],a=1;a<=Candy.NUM_OF_LEVELS_TO_LOAD;a+=1)c+b.buttonWidth>=Candy.GAME_WIDTH+b.buttonWidth/2&&(c=b.leftSpacing,d+=b.buttonHeight),this.buttonArray.push(new Candy.LabelButton(this.game,c,d,"blueButtons","Level "+a,this.startGameMaker(a),this,1,0,2)),c+=b.buttonWidth+b.leftSpacing,c+b.buttonWidth>=Candy.GAME_WIDTH+b.buttonWidth/2&&(d+=b.topSpacing);this.addLevelMaps()},startGameMaker:function(a){"use strict";return function(){Candy.levelData.currentLevel=a,this.state.start("Game")}}},Candy.MainMenu=function(){"use strict"},Candy.MainMenu.prototype={create:function(){"use strict";var a=this.cache.getJSON("menuConfig"),b='Goal: collect the star!\nControls: arrows to move, duck and climb.\nSpacebar to jump.\nPress "a" to make a rope.';this.add.sprite(0,0,"background"),this.add.text(100,100,b,{font:"20px Arial",fill:"#000044",align:"left"}),this.startButton=new Candy.LabelButton(this.game,a.startButton.x,a.startButton.y,"blueButtons","Start Endless Mode",this.startGame,this,1,0,2)},startGame:function(){"use strict";this.state.start("Game")}},Candy.Preloader=function(a){"use strict";Candy.game=a,Candy.saveManager={game:a,save:function(){localStorage.setItem(Candy.Game.prototype.SAVE_KEY,JSON.stringify(Candy.saveData))},load:function(){Candy.saveData=JSON.parse(localStorage.getItem(Candy.Game.prototype.SAVE_KEY)),Candy.saveData&&Candy.saveData.version===Candy.SAVE_VERSION||(Candy.saveData=this.makeDefaultSaveData(),this.save())},loadLevels:function(){var a,b=1,c=this;for(b=1;b<=Candy.NUM_OF_LEVELS_TO_LOAD;b+=1)a="level"+b,c.game.load.tilemap(a,"levels/"+a+".json",null,Phaser.Tilemap.TILED_JSON);Candy.levelData.currentLevel=1},makeDefaultSaveData:function(){var a,b=[];for(a=0;a<Candy.NUM_OF_LEVELS_TO_LOAD;a+=1)b[a]=0;return{data:b,vesrion:Candy.SAVE_VERSION}},getCurrentLevelMap:function(){return Candy.levelData.currentLevel||this.loadLevels(),Candy.levelData.levels[Candy.levelData.currentLevel]},getLevelNameFromNumber:function(a){return"level"+a}},Candy.spriteDoesNotCollideWithLayers=function(a,b){return b.every(function(b){return b.getTiles(a.x,a.y,a.width,a.height,!0).length<=0})}},Candy.Preloader.prototype={preload:function(){"use strict";this.stage.backgroundColor="#00BEEF",this.preloadBar=this.add.sprite((Candy.CONSTANTS.GAME_WIDTH-311)/2,(Candy.CONSTANTS.GAME_HEIGHT-27)/2,"preloaderBar"),this.load.setPreloadSprite(this.preloadBar),this.load.image("background","assets/background.png"),this.load.image("sky","assets/sky.png"),this.load.image("ground","assets/platform.png"),this.load.image("star","assets/newStar.png"),this.load.image("rope","assets/lightRope.png"),this.load.image("ropeBall","assets/ropeBall.png"),this.load.spritesheet("ropeSheet","assets/ropeSheet.png",Candy.CONSTANTS.TILE_WIDTH,Candy.CONSTANTS.TILE_HEIGHT),this.load.spritesheet("dude","assets/bluedude.png",Candy.CONSTANTS.DISPLAY_PLAYER_WIDTH,Candy.CONSTANTS.DISPLAY_PLAYER_HEIGHT),this.load.spritesheet("blueButtons","assets/190x49buttons.png",190,49),this.load.audio("jump","audio/jump.mp3",!0),this.load.audio("pickup","audio/pickup.mp3",!0),Candy.saveManager.load(),Candy.saveManager.loadLevels(),this.load.image("tileset_16x16","assets/tileset_16x16.png"),this.time.desiredFps=30,this.load.json("menuConfig","config/menu.json"),this.load.json("levelSelectConfig","config/levelSelect.json")},update:function(){"use strict";this.cache.isSoundDecoded("pickup")&&this.state.start("MainMenu")}};